# 常见漏洞修复建议

## sql注入

* 过滤危险字符，采用正则表达式匹配union、sleep、load_file等关键字，如果匹配到，则退出程序，这种存在被绕过的可能
* 使用预编译语句，使用PDO预编译语句，需要注意的是不能将变量直接拼接到PDO语句中，而是使用占位符进行数据库的增删改查

## xss

* 过滤输入的数据，包括 ‘ 、“、<、>、on* 等非法字符
* 对输出到页面的数据进行相应的编码转换，包括HTML实体编码、JavaScript编码、属性以及URL请求参数
* 设置cookie的HttpOnly属性

## CSRF

* 验证请求的Referer值，如果Referer是以自己的网站开头的域名，则说明请求来源于自己，是合法的。如果Referer是其他网站或者空白，则有可能是CSRF攻击，那么服务器应拒绝该请求，此方法存在被绕过的可能
* 在请求中放入攻击者不能伪造的信息，如可以在HTTP请求中以参数的形式加入一个随机的token，并在服务器端验证token，如果请求中没有token或者token的内容不正确，则认为该请求可能是CSRF攻击从而拒绝请求。

## SSRF

* 限制请求的端口只能为web端口，只允许访问HTTP和HTTPS的请求
* 限制不能访问内网的ip，以防止对内网进行攻击
* 屏蔽返回的详细信息

## 文件上传漏洞

* 通过白名单的方式判断文件后缀是否合法
* 对上传后的文件进行重命名，例如rand(100,199).date("YmdHis").".jpg"

## 暴力破解

* 设置登录阈值，如果用户登录次数超过设置阈值，则锁定账号
* 设置IP登录阈值，如果某个IP登录次数超过设定阈值，则锁定IP（不适用于多个用户使用同一IP情况）

## 命令执行

* 尽量不要使用命令执行函数
* 客户端提交的变量在进入执行命令函数前要做好过滤和检测
* 在使用用动态函数之前，确保使用的函数是指定的函数之一
* 对PHP语言来说，不能完全控制的危险函数最好不要使用

## 逻辑漏洞

* 通过session来进行控制，例如在用户登录成功后，将username或uid写入到session中，当用户查看个人信息时，从session中取出username，而不是从get或post取username，那么此时取到的username就是没有被篡改的。

## XXE

* 禁止使用外部实体
* 过滤用户提交的XML数据，防止出现非法内容